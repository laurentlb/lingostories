<!doctype html>
<html lang="en">

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta property="og:type" content="website"/>
<meta property="og:site_name" content="LingoStories"/>
<meta property="og:description" content="A free collection of interactive stories for language learners." />
<title>LingoStories - free interactive stories for learning languages</title>

<link rel="stylesheet" href="style.css">

<div class="main">
    <div class="top">
        <a href="/"><img src="img/home.svg" class="icon top-icon" title="Back to the main page"></a>
        <details>
        <summary><img src="img/options.svg" class="icon top-icon" title="Settings"></summary>
        <ul>
            <li>
                <label>Navigation mode</label>
                <select id="mode">
                    <option title="Show the transcript immediately" value="audioAndText">Audio and text</option>
                    <option title="Show the transcript after a click" value="audioFirst">Audio first, then text</option>
                    <option title="Disable audio" value="textOnly">Text only</option>
                </select>
            <li>
                <label for="volume">Volume</label>
                <input type="range" min="0" max="1" step="0.01" value="1" class="slider" id="volume">
            <li title="How fast the voice speaks">
                <label>Voice speed</label>
                <input type="range" min="0.4" max="1.2" step="0.2" value="1" class="slider" id="rate">
            <li title="Voice used for the local TTS, which is used only as a backup"> <label>Voice</label>
                <select id="voice"></select>
            <li title="Automatically show the translation below the transcript">
                <label>Show translations</label>
                <input type="checkbox" id="showTranslations">
            <li title="Language used for the translations"> <label>Translation</label>
                <select id="targetLang">
                    <option value="en">English</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="pl">Polish</option>
                </select>
        </ul>
    </details>
    </div>

    <div class="middle">
        <div id="infoHeader">
            <h1> LingoStories </h1>
            <p style="font-style: italic;">
                A free collection of interactive stories for language learners.
            </p>
            <a href="https://discord.gg/7hCdq7Fj"><img class="logo" title="Discord community" src="img/discord.svg"></a>
            <a href="https://github.com/laurentlb/lingostories"><img class="inv-logo" title="GitHub" src="img/github.svg"></a>

            <p>
                <details>
                <summary>
                    <b>This is a work in progress. </b>
                </summary>
                    The stories are not complete; the translations were not proofread; the audio is generated by a computer and
                    may not be available on every system.
                </details>
            </p>
            <p>
                <a href="https://docs.google.com/document/d/1LppZEDHxceiFuagMOTKEwsR2ZfXev2sJ1TzfrVokNoc/edit?usp=sharing">Read FAQ on Google Docs</a> -
                <a href="https://forms.gle/9djaTH25wUN74psm8">Request new language</a>
            </p>
        </div>
        <div class="info" id="languageSelector">
            <p>Select a language to study.</p>
            <a href="?lang=fr"><img class="flag" src="img/flags/fr.svg">French</a><br>
            <a href="?lang=en"><img class="flag" src="img/flags/gb.svg">English</a><br>
            <a href="?lang=de"><img class="flag" src="img/flags/de.svg">German</a><br>
            <a href="?lang=pl"><img class="flag" src="img/flags/pl.svg">Polish</a><br>
        </div>
        <div class="info" style="display: none;" id="storySelector">
            <p>Select a story to read.</p>
            <img src="img/arrow-right-3-square.svg" class="icon choice-icon" onclick="chooseStory(0)">
            Introduction<br>
            <img src="img/arrow-right-3-square.svg" class="icon choice-icon" onclick="chooseStory(1)">
            Restaurant<br>
        </div>
        <div class="info" style="display: none;" id="no-voices">No voices available.</div>

        <div class="story"></div>
        <img src="img/comment-dots.svg" id="inlineNext" class="icon bubble-icon" onclick="next()">

        <div class="story-end">
            <img class="certificate" src="img/certificate-badge.svg">
            <h2>Congratulations!</h2>
            <p>You've reached the end of the story.</p>

            <div style="display: flex;">
                <img class="icon player-icon" src="img/exit.svg" title="Choose another story" onclick="backToMenu();">
                <img class="icon player-icon" src="img/restart.svg" title="Restart the story" onclick="resetStory(); next();">
            </div>
        </div>

        <div style="height: 30vh;"></div>
    </div>

</div>
<div class="footer">
    <img class="icon player-icon" src="img/player-play.svg" title="Next" onclick="next();">
    <img class="icon player-icon" src="img/player-end.svg" title="Show All" onclick="showAll();">
    <img class="icon player-icon" src="img/restart.svg" title="Restart the story" onclick="resetStory(); next();">
</div>

<script>
let synth = window.speechSynthesis;
let voices = [];
let spoiler = null;
let lang = null;
let sentenceIndex = 0;
let pageIndex = 0;
let openTransl = null;
let storyName = null;

synth.getVoices();

synth.onvoiceschanged = function() {
    updateVoices();
};

function updateVoices() {
  synth = window.speechSynthesis;
  voices = synth.getVoices();
  console.log("Available voices", voices);

  if (lang == null) {
    return;
  }

  const voiceSelect = document.querySelector("#voice");
  voiceSelect.innerHTML = "";
  let voicesAvailable = false;
  for (let i = 0; i < voices.length; i++) {
    const option = document.createElement("option");
    if (!voices[i].lang.startsWith(lang)) {
        continue;
    }
    option.textContent = voices[i].name;
    option.value = i;

    option.setAttribute("data-lang", voices[i].lang);
    option.setAttribute("data-name", voices[i].name);
    voiceSelect.appendChild(option);
    voicesAvailable = true;
  }

  document.querySelector("#no-voices").style.display = voicesAvailable ? "none" : "block";
  if (!voicesAvailable) {
    document.querySelector("#mode").value = "textOnly";
  } else {
    document.querySelector("#mode").value = "audioAndText";
  }
}

function resetStory() {
    sentenceIndex = 0;
    pageIndex = 0;
    spoiler = null;
    document.querySelector('.story').innerHTML = "";
    document.querySelector('.story-end').style.display = "none";
    document.querySelector('.footer').style.display = "flex";
}

function setLanguage(l) {
    lang = l;
    transLang = l === "en" ? "fr" : "en";
    document.querySelector('.top').style.display = "block";
    updateVoices();
    document.querySelector("#storySelector").style.display = "block";
    document.querySelector("#languageSelector").style.display = "none";

    const target = document.querySelector("#targetLang").value;
    if (target === lang) {
        document.querySelector("#targetLang").value =
            lang === "en" ? "fr" : "en";
    }
}

let sentences = {};

class Page {
    constructor(text, choices, image) {
        this.text = text;
        this.choices = choices;
        this.image = image;
    }
}

async function chooseStory(index) {
    document.querySelector('.footer').style.display = "flex";
    document.querySelector('#infoHeader').style.display = "none";
    document.querySelector("#storySelector").style.display = "none";

    storyName = index === 0 ? "intro" : "restaurant";
    const response = await fetch(`stories/${storyName}.json`);
    const story = await response.json();

    for (let page in story) {
        const text = story[page][0];
        for (let lang in text) {
            text[lang] = text[lang].split("|");
        }
        const choices = story[page].slice(1);
        const image = story[page][0]["img"];
        sentences[page] = new Page(text, choices, image);
    }

    console.log(sentences);
    resetStory();
    next();
}

const audio = new Audio();

function listenMP3(sentenceIndex) {
    const file = `audio/${storyName}-${lang}-${pageIndex}-${sentenceIndex}.mp3`;
    audio.src = file;
    audio.playbackRate = document.querySelector("#rate").value;
    audio.volume = document.querySelector("#volume").value;

    // audio.onended = (event) => {console.log("ended");};

    audio.play().catch((e) => {
        listen(sentences[pageIndex].text[lang][sentenceIndex]);
    });
}

function listen(text) {
    const voice = voices[document.querySelector("#voice").value];
    if (voice == null) {
        return;
    }
    var msg = new SpeechSynthesisUtterance(text);
    msg.voice = voice;
    msg.lang = lang;
    msg.rate = document.querySelector("#rate").value;
    msg.volume = document.querySelector("#volume").value;
    speechSynthesis.cancel();
    speechSynthesis.speak(msg);
}

function createTranslation(parent, pageIndex, sentenceIndex) {
    const transl = document.createElement("p");
    const transLang = document.querySelector("#targetLang").value;
    transl.textContent = sentences[pageIndex].text[transLang][sentenceIndex];
    transl.textContent = sentences[pageIndex].text[transLang][sentenceIndex];
    transl.classList.add("translation");
    if (openTransl) {
        openTransl.remove();
        openTransl = null;
    }
    transl.style.display = showTranslations ? "block" : "none";
    openTransl = transl;

    parent.appendChild(transl);
}

function showText(pageIndex, sentenceIndex, useSpoiler) {
    const content = sentences[pageIndex].text[lang][sentenceIndex];
    const index = sentenceIndex;
    const icon = document.createElement("img");
    icon.src = "img/volume-up.svg";
    icon.classList.add("icon", "audio-icon");
    icon.onclick = () => {
        listenMP3(index);
    };

    const container = document.createElement("span");
    container.classList.add("audio-icon-container");
    container.appendChild(icon);

    const elt = document.createElement("span");
    if (useSpoiler) {
        elt.classList.add("spoiler");
        spoiler = elt;
    }

    elt.classList.add("text");
    elt.textContent = content;

    const main = document.querySelector('.story');
    let showTranslation = document.querySelector("#showTranslations").checked || storyName === "intro";
    if (showTranslation) {
        createTranslation(elt, pageIndex, sentenceIndex);
    }

    elt.onclick = () => {
        if (elt.classList.contains("spoiler")) {
            next();
            return;
        }
        if (showTranslation) {
            openTransl.remove();
            openTransl = null;
            showTranslation = false;
        }
        else {
            if (openTransl) {
                openTransl.remove();
                openTransl = null;
            }
            showTranslation = true;
            createTranslation(elt, pageIndex, sentenceIndex);
        }
    }

    const title = pageIndex === 0 && sentenceIndex === 0;
    const div = document.createElement(title ? "h2" : "p");
    div.appendChild(container);
    div.appendChild(elt);
    main.appendChild(div);

    window.scrollTo(0, document.body.scrollHeight);
}

function openPage(index) {
    pageIndex = index;
    sentenceIndex = 0;
    spoiler = null;

    const image = sentences[pageIndex].image;
    if (image) {
        const img = document.createElement("img");
        img.src = `img/stories/${image}`;
        img.classList.add("story-image");
        const main = document.querySelector('.story');
        main.appendChild(img);
    }

    next();
}

function showChoices() {
    const choices = sentences[pageIndex].choices;

    // Automatically go to the next page if there is only one choice.
    if (choices.length === 1 && !choices[0]["en"]) {
        openPage(choices[0]["goto"]);
        return;
    }

    const main = document.querySelector('.story');
    const container = document.createElement("div");
    container.classList.add("choices");

    for (let i = 0; i < choices.length; i++) {
        const text = choices[i][lang];
        const elt = document.createElement("div");
        elt.classList.add("choice");
        elt.textContent = text;
        elt.title = text;

        const transl = document.createElement("p");
        transl.textContent = choices[i][transLang];
        transl.classList.add("translation");
        transl.style.display = "none";
        elt.appendChild(transl);

        elt.onclick = () => {
            if (transl.style.display === "block") {
                transl.style.display = "none";
            }
            else {
                transl.style.display = "block";
            }
        }

        const icon = document.createElement("img");
        icon.src = "img/arrow-right-3-square.svg";
        icon.classList.add("icon", "choice-icon");
        icon.onclick = () => {
            container.innerHTML = "";
            container.appendChild(elt);
            
            openPage(sentences[pageIndex].choices[i]["goto"]);
            //openPage(text.split("#")[0]);
        };

        container.appendChild(icon);
        container.appendChild(elt);
    }

    if (choices.length === 0) {
        document.querySelector(".story-end").style.display = "block";
        document.querySelector('.footer').style.display = "none";
    } else {
        main.appendChild(container);
        sentenceIndex++;
    }
    const inlineNext = document.getElementById("inlineNext");
    inlineNext.style.display = "none";

    window.scrollTo(0, document.body.scrollHeight);
}

function backToMenu() {
    resetStory();
    document.querySelector('#infoHeader').style.display = "block";
    document.querySelector('#storySelector').style.display = "block";
}

function revealSpoiler() {
    spoiler.classList.remove("spoiler");
    spoiler.classList.add("revealed");
    spoiler = null;
    const inlineNext = document.getElementById("inlineNext");
    inlineNext.style.display = "block";
}

function showAll() {
    if (sentenceIndex > sentences[pageIndex].text[lang].length) {
        return;
    }
    if (spoiler) {
        revealSpoiler();
    }
    while (sentenceIndex < sentences[pageIndex].text[lang].length) {
        showText(pageIndex, sentenceIndex, false);
        sentenceIndex++;
    }
    showChoices();
}

const next = () => {
    const inlineNext = document.getElementById("inlineNext");

    if (spoiler) {
        revealSpoiler();
        return;
    }

    inlineNext.style.display = "none";
    if (sentenceIndex == sentences[pageIndex].text[lang].length) {
        sentenceIndex++;
        showChoices();
        return;
    }
    if (sentenceIndex > sentences[pageIndex].text[lang].length) {
        return;
    }
    const useSpoiler = document.querySelector("#mode").value === "audioFirst";
    showText(pageIndex, sentenceIndex, useSpoiler);
    if (document.querySelector("#mode").value !== "audioFirst") {
        inlineNext.style.display = "block";
    }
    if (document.querySelector("#mode").value !== "textOnly") {
        listenMP3(sentenceIndex);
    }
    sentenceIndex++;
};

window.onload = function(){ 
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has("lang")) {
        setLanguage(urlParams.get("lang"));
    }

    if (urlParams.has("story")) {
        chooseStory(Number(urlParams.get("story")));
    }
};

</script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SJPVM9P6EP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SJPVM9P6EP');
</script>
