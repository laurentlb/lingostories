<!doctype html>
<html lang="en">

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body, html {
    margin: 0;
    padding: 0;
    background: linear-gradient(122deg, var(--main-bg-color) 0%, #141414 100%);
    background-repeat: no-repeat;
    background-attachment: fixed;
    font-family: sans-serif;
    color: var(--main-text-color);
    letter-spacing: .05em;
    font-size: 18px;

    --border-color: #444;
    --main-text-color: #ddd;
    --secondary-text-color: #8a8;
    --panel-bg-color: ##18181e;
    --panel-hover-bg-color: #101010;
    --main-bg-color: #303030;
}

.spoiler {
    user-select: none;
    filter: blur(5px);
    transition: all .2s;
    animation: spoilertext 1s;
}

@keyframes spoilertext {
    0% {
        color: transparent;
    }
    100% {
        color: var(--main-text-color);
    }
}

.revealed {
    animation: reveal 1s;
}

input[type="button"] {
    border: 1px solid var(--border-color);
    background: #000;
    color: #fff;
    cursor: pointer;
    border-radius: 16px;
    padding: 8px 16px;
    transition: all .2s;
    margin: 2px;
}

input {
    font-size: 1rem;
}

input[type="button"] {
    border: 1px solid var(--border-color);
    background: #0008;
    color: #fff;
    cursor: pointer;
    border-radius: 16px;
    padding: 8px 16px;
    transition: all .2s;
}

.audio:hover, input[type="button"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
}

.text:hover {
    text-shadow: 4px 4px 8px #fff4;
}

@keyframes reveal {
    0% {
        filter: blur(5px);
    }
    100% {
        filter: blur(0px);
    }
}

.text {
    cursor: help;
}

.audio {
    width: 1rem;
    height: 1rem;
    cursor: pointer;
    padding-right: 8px;
    transition: all .2s;
}

.img-choice {
    height: 48px;
    cursor: pointer;
    vertical-align: middle;
    margin-right: 8px;
}

.translation {
    font-size: 0.8rem;
    color: #999;
    font-style: italic;
    margin-block-start: 0.2em;
}

.main {
    max-width: 500px;
    margin: 0 auto;
}

summary {
    cursor: pointer;
}

.top {
    background-color: #101010;
    border: 1px solid var(--border-color);
    padding: 4px;
    position: fixed;
    left: 0;
    top: 0;
    border-radius: 16px;
    padding: 8px 16px;
    display: none;
}

.topRight {
    background-color: #101010;
    border: 1px solid var(--border-color);
    padding: 4px;
    position: fixed;
    right: 0;
    top: 0;
    border-radius: 16px;
    padding: 8px 16px;
}

.footer {
    border-top: 1px solid var(--border-color);
    position: fixed;
    bottom: 0;
    height: 140px;
    background: inherit;
    width: 100%;
    padding: 8px;
    align-items: center;
    /* display: flex; */
    justify-content: center;
    display: none;
}

.info {
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 16px 16px;
    margin: 8px 0;
}

.choices {
    border: 1px solid var(--border-color);
    background-color: #000;
    border-radius: 16px;
    padding: 8px 16px;
    cursor: help;
    margin: 1em 0em;
}

.choice {
    display: inline-block;
    width: 80%;
    vertical-align: middle;
}

.middle {
    padding: 4px;
    margin-top: 2em;
}

li > label {
    display: inline-block;
    width: 180px;
}

a {
    color: #aaf;
}

p {
    margin-block-start: 0em;
}

details > ul {
    padding-left: 0;
    list-style-type: none;
}

.flag {
    width: 48px;
    vertical-align: middle;
    border-radius: 4px;
    margin: 8px;
}

</style>

<div class="main">
    <div class="topRight">
        <a href="?">X</a>
    </div>

    <div class="top">
    <details>
        <summary>Settings</summary>
        <ul>
            <li>
                <label>Navigation mode</label>
                <select id="mode">
                    <option value="audioAndText">Audio and text</option>
                    <option value="audioFirst">Audio first, then text</option>
                    <option value="textOnly">Text only</option>
                </select>
            <li>
                <label for="volume">Volume</label>
                <input type="range" min="0" max="1" step="0.01" value="1" class="slider" id="volume">
            <li>
                <label>Voice speed</label>
                <input type="range" min="0.4" max="1.2" step="0.2" value="1" class="slider" id="rate">
            <li> <label>Voice</label>
                <select id="voice"></select>
            <li>
                <label>Show translations</label>
                <input type="checkbox" id="showTranslations" checked>
                <!-- <li> <label>Translations</label>
            <select id="targetLang">
                <option value="en-GB">English</option>
                <option value="fr-FR">French</option>
                <option value="pl-PL">Polish</option>
            </select> -->
        </ul>
    </details>
    </div>

    <div class="middle">
        <div id="infoHeader">
            <h1> LingoStories </h1>
            <p>
                A free collection of interactive stories for language learners.
            </p>
            <p>
                <b>This is a work in progress.</b> The stories are not complete; the translations were not proofread; the audio is generated by a computer and
                may not be available on every system.
            </p>
            <p>
                <a href="https://docs.google.com/document/d/1LppZEDHxceiFuagMOTKEwsR2ZfXev2sJ1TzfrVokNoc/edit?usp=sharing">About</a> - <a href="https://discord.gg/7hCdq7Fj">Discord</a>
            </p>
        </div>
        <div class="info" id="languageSelector">
            <p>Select a language to study.</p>
            <a href="?lang=fr">
            <img class="flag" src="https://raw.githubusercontent.com/lipis/flag-icons/main/flags/4x3/fr.svg">French</a><br>
            <a href="?lang=en"><img class="flag" src="https://raw.githubusercontent.com/lipis/flag-icons/main/flags/4x3/gb.svg">English</a><br>
            <a href="?lang=de"><img class="flag" src="https://raw.githubusercontent.com/lipis/flag-icons/main/flags/4x3/de.svg">German</a>
        </div>
        <div class="info" style="display: none;" id="storySelector">
            <p>Select a story to read.</p>
            <input type="button" value="Introduction" onclick="chooseStory(0)"><br>
            <input type="button" value="Restaurant" onclick="chooseStory(1)"><br>
        </div>
        <div class="info" style="display: none;" id="no-voices">No voices available.</div>

        <div class="story"></div>
        <input type="button" value="..." id="inlineNext"  style="display: none;" onclick="next()">
        <div style="height: 30vh;"></div>
    </div>

</div>
<div class="footer">
    <input type="button" value="Next" id="next" onclick="next()">
    <input type="button" value="Show All" id="next" onclick="showAll();">
    <input type="button" value="Restart" id="next" onclick="resetStory(); next();">
</div>

<script>
let synth = window.speechSynthesis;
let voices = [];
let spoiler = null;
let lang = null;
let sentenceIndex = 0;
let pageIndex = 0;
let openTransl = null;

synth.getVoices();

synth.onvoiceschanged = function() {
    updateVoices();
};

function updateVoices() {
  synth = window.speechSynthesis;
  voices = synth.getVoices();
  console.log("Available voices", voices);

  if (lang == null) {
    return;
  }

  const voiceSelect = document.querySelector("#voice");
  voiceSelect.innerHTML = "";
  let voicesAvailable = false;
  for (let i = 0; i < voices.length; i++) {
    const option = document.createElement("option");
    if (!voices[i].lang.startsWith(lang)) {
        continue;
    }
    option.textContent = voices[i].name;
    option.value = i;

    option.setAttribute("data-lang", voices[i].lang);
    option.setAttribute("data-name", voices[i].name);
    voiceSelect.appendChild(option);
    voicesAvailable = true;
  }

  document.querySelector("#no-voices").style.display = voicesAvailable ? "none" : "block";
  if (!voicesAvailable) {
    document.querySelector("#mode").value = "textOnly";
  } else {
    document.querySelector("#mode").value = "audioAndText";
  }
}

function resetStory() {
    sentenceIndex = 0;
    pageIndex = 0;
    spoiler = null;
    document.querySelector('.story').innerHTML = "";
}

function setLanguage(l) {
    resetStory();
    lang = l;
    transLang = l === "en" ? "fr" : "en";
    document.querySelector('.top').style.display = "block";
    updateVoices();
    document.querySelector("#storySelector").style.display = "block";
    document.querySelector("#languageSelector").style.display = "none";
}

let sentences = {};

function chooseStory(index) {
    document.querySelector('.footer').style.display = "flex";
    document.querySelector('#infoHeader').style.display = "none";
    document.querySelector("#storySelector").style.display = "none";

    const story = index === 0 ? sentences1 : sentences2;
    for (let page in story) {
        sentences[page] = {};
        for (let lang in story[page]) {
            sentences[page][lang] = story[page][lang][0].split("|");
            sentences[page][lang].choices = story[page][lang].slice(1);
        }
    }

    console.log(sentences);
    resetStory();
    next();
}

const sentences1 = {
    0: {
        "fr": [
            "Introduction|Bonjour !|Bienvenue dans LingoStories.|Comment ça va ?",
            "1#Bien, merci.",
            "1#Pas mal.",
        ],
        "en": [
            "Introduction|Hello!|Welcome to LingoStories.|How are you?",
            "1#Good, thank you.",
            "1#Not bad.",
        ],
        "de": [
            "Einführung|Hallo!|Willkommen bei LingoStories.|Wie geht es dir?",
            "1#Gut, danke.",
            "1#Nicht schlecht.",
        ]
    },
    1: {
        "fr": [
            "Sur ce site, il y a des histoires interactives.|Choisis une histoire qui est facile pour toi.|Tu ne comprendras peut-être pas tous les mots.|Ce n'est pas grave.|Continue quand même.|Écoute chaque phrase.|Lis chaque phrase.|Écoute chaque phrase plusieurs fois si tu veux.|Tu reconnaîtras peut-être quelques mots.|Clique sur une phrase pour voir sa traduction.|Ça t'aidera à suivre l'histoire.|Ça t'aidera à comprendre.|Tu peux maintenant choisir une histoire.",
        ],
        "en": [
            "On this website, there are interactive stories.|Choose a story that is easy for you.|You may not understand all the words.|That's okay.|Continue anyway.|Listen to each sentence.|Read each sentence.|Listen to each sentence several times if you want.|You may recognize some words.|Click on a sentence to see its translation.|It will help you follow the story.|It will help you understand.|You can now choose a story.",
        ],
        "de": [
            "Auf dieser Website gibt es interaktive Geschichten.|Wähl eine Geschichte, die für dich einfach ist.|Vielleicht verstehst du nicht alle Wörter.|Das ist in Ordnung.|Mach trotzdem weiter.|Hör dir jeden Satz an.|Lies jeden Satz.|Hör dir jeden Satz mehrmals an, wenn du willst.|Vielleicht erkennst du einige Wörter.|Klick auf einen Satz, um seine Übersetzung zu sehen.|Es wird dir helfen, der Geschichte zu folgen.|Es wird dir helfen, zu verstehen.|Du kannst jetzt eine Geschichte auswählen.",
        ]
    }
};

const sentences2 =
    {0: 
        {"en": [
             "At the restaurant|You walk in the city. You are hungry.|You look around you.|You see a nice restaurant.|You enter the restaurant.|Inside the restaurant, there are many tables.|There are many people too.|They are eating and chatting.|You see a waiter.|The waiter says: \"Hello and welcome to our restaurant!\"|You reply: \"Hello, I would like a table for one.\"|The waiter brings you to a table and asks what you would like to drink.",
             "1#Ask for water",
             "2#Ask for wine",
        ],
         "fr": [
            "Au restaurant|Tu marches dans la ville. Tu as faim.|Tu regardes autour de toi.|Tu vois un bon restaurant.|Tu entres dans le restaurant.|Dans le restaurant, il y a beaucoup de tables.|Il y a beaucoup de gens.|Ils mangent et discutent.|Tu vois un serveur.|Le serveur dit: \"Bonjour et bienvenue dans notre restaurant!\"|Tu réponds: \"Bonjour, je voudrais une table pour une personne, s'il vous plaît.\"",
            "1#Demander de l'eau",
            "2#Demander du vin",
        ],
        "de": [
            "Im Restaurant|Du gehst durch die Stadt. Du bist hungrig.|Du siehst dich um.|Du siehst ein schönes Restaurant.|Du betrittst das Restaurant.|Im Restaurant gibt es viele Tische.|Da sind auch viele Leute.|Sie essen und quatschen.|Du siehst einen Kellner.|Der Kellner sagt: „Hallo und willkommen in unserem Restaurant!“|Du antwortest: „Hallo, ich hätte gerne einen Tisch für eine Person.“|Der Kellner bringt dich an einen Tisch und fragt, was du trinken möchtest.",
            "1#Nach Wasser fragen.",
            "2#Nach Wein fragen.",
        ]
        },
    1:
        {"en": [
            "You order water.",
            "2#Ask for wine",
        ],
        "fr": [
            "Tu commandes de l'eau.",
            "2#Demander du vin",
        ],
        "de": [
            "Du bestellst Wasser.",
            "2#Nach Wein fragen.",
        ],
    },
    2:
        {"en": [
            "You order wine.",
        ],
        "fr": [
            "Tu commandes du vin.",
        ],
        "de": [
            "Du bestellst Wein.",
        ],
        }
    };

function listen(text) {
    console.log("listen", text);
    const voice = voices[document.querySelector("#voice").value];
    if (voice == null) {
        return;
    }
    var msg = new SpeechSynthesisUtterance(text);
    msg.voice = voice;
    msg.lang = lang;
    msg.rate = document.querySelector("#rate").value;
    msg.volume = document.querySelector("#volume").value;
    speechSynthesis.cancel();
    speechSynthesis.speak(msg);
    console.log("speak", msg.volume, text);
}

function showText(useSpoiler) {
    const content = sentences[pageIndex][lang][sentenceIndex];
    const icon = document.createElement("img");
    icon.src = "https://d35aaqx5ub95lt.cloudfront.net/images/d636e9502812dfbb94a84e9dfa4e642d.svg";
    icon.classList.add("audio");
    icon.onclick = () => {
        listen(content);
    };

    const elt = document.createElement("span");
    if (useSpoiler) {
        elt.classList.add("spoiler");
        spoiler = elt;
    }

    elt.classList.add("text");
    elt.textContent = content;

    const main = document.querySelector('.story');

    const transl = document.createElement("p");
    transl.textContent = sentences[pageIndex][transLang][sentenceIndex];
    transl.classList.add("translation");
    if (openTransl) {
        openTransl.style.display = "none";
    }
    transl.style.display = document.querySelector("#showTranslations").checked ? "block" : "none";
    openTransl = transl;
    elt.title = sentences[pageIndex][transLang][sentenceIndex];

    elt.onclick = () => {
        if (elt.classList.contains("spoiler")) {
            next();
            return;
        }
        if (transl.style.display === "block") {
            transl.style.display = "none";
        }
        else {
            if (openTransl) {
                openTransl.style.display = "none";
            }
            transl.style.display = "block";
            openTransl = transl;
        }
    }

    const title = pageIndex === 0 && sentenceIndex === 0;
    const div = document.createElement(title ? "h2" : "p");
    div.appendChild(icon);
    div.appendChild(elt);
    div.appendChild(transl);
    main.appendChild(div);

    window.scrollTo(0, document.body.scrollHeight);
}

function openPage(index) {
    pageIndex = index;
    sentenceIndex = 0;
    spoiler = null;
    next();
}

function showChoices() {
    const main = document.querySelector('.story');
    const container = document.createElement("div");
    container.classList.add("choices");

    const choices = sentences[pageIndex][lang].choices;
    for (let i = 0; i < choices.length; i++) {
        const text = sentences[pageIndex][lang].choices[i];
        const elt = document.createElement("div");
        elt.classList.add("choice");
        elt.textContent = sentences[pageIndex][lang].choices[i].split("#")[1];
        elt.title = sentences[pageIndex][transLang].choices[i].split("#")[1];

        const transl = document.createElement("p");
        transl.textContent = sentences[pageIndex][transLang].choices[i].split("#")[1];
        transl.classList.add("translation");
        transl.style.display = "none";
        elt.appendChild(transl);

        elt.onclick = () => {
            if (transl.style.display === "block") {
                transl.style.display = "none";
            }
            else {
                transl.style.display = "block";
            }
        }

        const icon = document.createElement("img");
        icon.src = "https://upload.wikimedia.org/wikipedia/commons/0/0d/Arrow-right-narrow-small.svg";
        icon.classList.add("img-choice");
        icon.onclick = () => {
            container.innerHTML = "";
            container.appendChild(elt);
            
            openPage(Number(text.split("#")[0]));
        };

        container.appendChild(icon);
        container.appendChild(elt);
    }

    if (choices.length === 0) {
        const elt = document.createElement("div");
        elt.classList.add("info");
        elt.textContent = "This is the end of the story.";
        const btn = document.createElement("input");
        btn.type = "button";
        btn.value = "End";
        btn.onclick = () => {
            resetStory();
            document.querySelector('#infoHeader').style.display = "block";
            document.querySelector('#storySelector').style.display = "block";
        };
        elt.appendChild(btn);
        main.appendChild(elt);
    } else {
        main.appendChild(container);
        sentenceIndex++;
    }
    const inlineNext = document.getElementById("inlineNext");
    inlineNext.style.display = "none";

    window.scrollTo(0, document.body.scrollHeight);
}

function revealSpoiler() {
    spoiler.classList.remove("spoiler");
    spoiler.classList.add("revealed");
    spoiler = null;
    const inlineNext = document.getElementById("inlineNext");
    inlineNext.style.display = "block";
}

function showAll() {
    if (sentenceIndex > sentences[pageIndex][lang].length) {
        return;
    }
    if (spoiler) {
        revealSpoiler();
    }
    while (sentenceIndex < sentences[pageIndex][lang].length) {
        showText();
        sentenceIndex++;
    }
    showChoices();
}

const next = () => {
    const inlineNext = document.getElementById("inlineNext");

    if (spoiler) {
        revealSpoiler();
        return;
    }

    inlineNext.style.display = "none";
    if (sentenceIndex == sentences[pageIndex][lang].length) {
        showChoices();
        sentenceIndex++;
        return;
    }
    if (sentenceIndex > sentences[pageIndex][lang].length) {
        return;
    }
    const useSpoiler = document.querySelector("#mode").value === "audioFirst";
    showText(useSpoiler);
    if (document.querySelector("#mode").value !== "audioFirst") {
        inlineNext.style.display = "block";
    }
    if (document.querySelector("#mode").value !== "textOnly") {
        listen(sentences[pageIndex][lang][sentenceIndex]);
    }
    sentenceIndex++;
};

window.onload = function(){ 
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has("lang")) {
        setLanguage(urlParams.get("lang"));
    }

    if (urlParams.has("story")) {
        chooseStory(Number(urlParams.get("story")));
    }
};

</script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SJPVM9P6EP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SJPVM9P6EP');
</script>
